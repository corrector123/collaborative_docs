import{_ as D,r as h,m as $,a as k,o as u,c as m,b as t,d,e as v,F as A,j,t as l,u as x,v as F,y as c,E as S,z as p,n as B,q as U,L as G,M as J,N as O,p as q,h as H}from"./index-3a7fb919.js";import{G as K,A as Q,R as W}from"./index-f33f8cd7.js";const X=g=>(q("data-v-64435c7a"),g=g(),H(),g),Y={class:"message-centre"},Z={class:"message-list"},ee={class:"message-header"},se=X(()=>t("h2",null,"消息中心",-1)),te={class:"message-actions"},ae={class:"message-items"},oe=["onClick"],ce={class:"message-item-header"},ne={class:"message-meta"},ie={class:"message-sender"},le={class:"message-date"},re={class:"message-actions"},de={class:"message-preview"},_e={key:0,class:"message-detail"},ue={class:"detail-header"},me={class:"detail-actions"},ve={class:"detail-meta"},pe={class:"sender"},ge={class:"date"},he={class:"detail-content"},fe={key:1,class:"message-empty"},ye={__name:"index",setup(g){const f=e=>JSON.parse(JSON.stringify(e)),r=h([]);h(0);const a=h(null),i=h([]),C=e=>e?new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",N=e=>{a.value=f(e),e.is_read||(e.is_read=!0,b(e.message_id))},y=async()=>{try{const e=await K();if(console.log("API原始响应:",e),e.code===200){const s=f(e.data.messages);console.log("去除Proxy后的数据:",s),r.value=s,console.log("最终的messageList:",r.value)}else c.error(e.message||"获取消息失败")}catch(e){console.error("获取消息失败:",e),c.error("获取消息列表失败")}},P=async e=>{try{await S.confirm("确定接受此邀请吗？","确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"success"});const s=a.value.file_id,n=a.value.sender_id,_=await Q({userid:0,targetId:n,file_id:s});_.code===200?(c.success("已接受邀请"),e.is_read=!0,await y()):c.error(_.message||"操作失败")}catch(s){s!=="cancel"&&(console.error("接受邀请失败:",s),c.error("操作失败"))}},V=async e=>{try{await S.confirm("确定拒绝此邀请吗？","确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const s=await W(e.message_id);s.code===200?(c.success("已拒绝邀请"),e.is_read=!0,await y()):c.error(s.message||"操作失败")}catch(s){s!=="cancel"&&(console.error("拒绝邀请失败:",s),c.error("操作失败"))}},w=async e=>{var s;try{r.value=r.value.filter(n=>n.message_id!==e),((s=a.value)==null?void 0:s.message_id)===e&&(a.value=null),c.success("删除成功")}catch{c.error("删除失败")}},b=async e=>{},z=()=>{i.value=f(r.value.filter(e=>e.selected))},E=async()=>{try{const e=i.value.map(s=>b(s.message_id));await Promise.all(e),i.value.forEach(s=>{const n=r.value.find(_=>_.message_id===s.message_id);n&&(n.is_read=!0)}),i.value=[],c.success("标记已读成功")}catch{c.error("标记已读失败")}},L=async()=>{try{const e=i.value.map(s=>w(s.message_id));await Promise.all(e),i.value=[],c.success("批量删除成功")}catch{c.error("批量删除失败")}},R=e=>e.title==="文件共享邀请提醒";return $(()=>{y()}),(e,s)=>{const n=k("el-button"),_=k("el-checkbox"),T=k("el-empty");return u(),m("div",Y,[t("div",Z,[t("div",ee,[se,t("div",te,[d(n,{type:"primary",size:"small",disabled:!i.value.length,onClick:E},{default:v(()=>[p(" 标记已读 ")]),_:1},8,["disabled"]),d(n,{type:"danger",size:"small",disabled:!i.value.length,onClick:L},{default:v(()=>[p(" 删除选中 ")]),_:1},8,["disabled"])])]),t("div",ae,[(u(!0),m(A,null,j(r.value,o=>{var M;return u(),m("div",{key:o.message_id,class:B(["message-item",{"message-unread":!o.is_read,"message-selected":o===a.value}]),onClick:I=>N(o)},[t("div",ce,[t("div",ne,[t("span",ie,l(o.sender_id),1),t("span",le,l(C(o.created_at)),1)]),t("div",re,[d(_,{modelValue:o.selected,"onUpdate:modelValue":I=>o.selected=I,onClick:s[0]||(s[0]=U(()=>{},["stop"])),onChange:z},null,8,["modelValue","onUpdate:modelValue"])])]),t("h3",{class:B(["message-item-title",{"font-bold":!o.is_read}])},l(o.title),3),t("p",de,l((M=o.content)==null?void 0:M.substring(0,100))+"...",1)],10,oe)}),128))])]),a.value?(u(),m("div",_e,[t("div",ue,[t("h2",null,l(a.value.title),1),t("div",me,[R(a.value)?(u(),m(A,{key:0},[d(n,{type:"success",size:"small",icon:x(G),onClick:s[1]||(s[1]=o=>P(a.value)),class:"action-button"},{default:v(()=>[p(" 接受 ")]),_:1},8,["icon"]),d(n,{type:"danger",size:"small",icon:x(J),onClick:s[2]||(s[2]=o=>V(a.value)),class:"action-button"},{default:v(()=>[p(" 拒绝 ")]),_:1},8,["icon"])],64)):F("",!0),d(n,{type:"text",icon:x(O),onClick:s[3]||(s[3]=o=>w(a.value.message_id))},{default:v(()=>[p(" 删除 ")]),_:1},8,["icon"])])]),t("div",ve,[t("span",pe,"从："+l(a.value.sender_id),1),t("span",ge,l(C(a.value.created_at)),1)]),t("div",he,l(a.value.content),1)])):(u(),m("div",fe,[d(T,{description:"选择一条消息查看详情"})]))])}}},Ce=D(ye,[["__scopeId","data-v-64435c7a"]]);export{Ce as default};
