import{f as U}from"./index-1faa59f6.js";import{b as N,U as T}from"./index-b0fcdce5.js";import{g as z}from"./shareDialog-e4f04e74.js";import{f as B}from"./index-a3cfd2ac.js";import{r as w,m as J,aa as R,ab as q,E as F,f as H,_ as G,a as V,o as S,i as W,e as C,b as P,d as k,z as E,c as A,F as $,j,t as D,u as K,y as I}from"./index-4a3dad6e.js";const me=d=>U({url:"/version/createVersion",method:"post",data:d}),fe=d=>U({url:"/version/getAllVersions",method:"post",data:d}),pe=d=>U({url:"/version/getVersionSnapshot",method:"post",data:d}),ge=d=>U({url:"/version/deleteVersion",method:"post",data:d});class _e{diff(e,t,o={}){let n;typeof o=="function"?(n=o,o={}):"callback"in o&&(n=o.callback);const u=this.castInput(e,o),a=this.castInput(t,o),l=this.removeEmpty(this.tokenize(u,o)),r=this.removeEmpty(this.tokenize(a,o));return this.diffWithOptionsObj(l,r,o,n)}diffWithOptionsObj(e,t,o,n){var u;const a=s=>{if(s=this.postProcess(s,o),n){setTimeout(function(){n(s)},0);return}else return s},l=t.length,r=e.length;let i=1,c=l+r;o.maxEditLength!=null&&(c=Math.min(c,o.maxEditLength));const m=(u=o.timeout)!==null&&u!==void 0?u:1/0,f=Date.now()+m,p=[{oldPos:-1,lastComponent:void 0}];let _=this.extractCommon(p[0],t,e,0,o);if(p[0].oldPos+1>=r&&_+1>=l)return a(this.buildValues(p[0].lastComponent,t,e));let y=-1/0,h=1/0;const v=()=>{for(let s=Math.max(y,-i);s<=Math.min(h,i);s+=2){let g;const b=p[s-1],x=p[s+1];b&&(p[s-1]=void 0);let L=!1;if(x){const O=x.oldPos-s;L=x&&0<=O&&O<l}const M=b&&b.oldPos+1<r;if(!L&&!M){p[s]=void 0;continue}if(!M||L&&b.oldPos<x.oldPos?g=this.addToPath(x,!0,!1,0,o):g=this.addToPath(b,!1,!0,1,o),_=this.extractCommon(g,t,e,s,o),g.oldPos+1>=r&&_+1>=l)return a(this.buildValues(g.lastComponent,t,e))||!0;p[s]=g,g.oldPos+1>=r&&(h=Math.min(h,s-1)),_+1>=l&&(y=Math.max(y,s+1))}i++};if(n)(function s(){setTimeout(function(){if(i>c||Date.now()>f)return n(void 0);v()||s()},0)})();else for(;i<=c&&Date.now()<=f;){const s=v();if(s)return s}}addToPath(e,t,o,n,u){const a=e.lastComponent;return a&&!u.oneChangePerToken&&a.added===t&&a.removed===o?{oldPos:e.oldPos+n,lastComponent:{count:a.count+1,added:t,removed:o,previousComponent:a.previousComponent}}:{oldPos:e.oldPos+n,lastComponent:{count:1,added:t,removed:o,previousComponent:a}}}extractCommon(e,t,o,n,u){const a=t.length,l=o.length;let r=e.oldPos,i=r-n,c=0;for(;i+1<a&&r+1<l&&this.equals(o[r+1],t[i+1],u);)i++,r++,c++,u.oneChangePerToken&&(e.lastComponent={count:1,previousComponent:e.lastComponent,added:!1,removed:!1});return c&&!u.oneChangePerToken&&(e.lastComponent={count:c,previousComponent:e.lastComponent,added:!1,removed:!1}),e.oldPos=r,i}equals(e,t,o){return o.comparator?o.comparator(e,t):e===t||!!o.ignoreCase&&e.toLowerCase()===t.toLowerCase()}removeEmpty(e){const t=[];for(let o=0;o<e.length;o++)e[o]&&t.push(e[o]);return t}castInput(e,t){return e}tokenize(e,t){return Array.from(e)}join(e){return e.join("")}postProcess(e,t){return e}get useLongestToken(){return!1}buildValues(e,t,o){const n=[];let u;for(;e;)n.push(e),u=e.previousComponent,delete e.previousComponent,e=u;n.reverse();const a=n.length;let l=0,r=0,i=0;for(;l<a;l++){const c=n[l];if(c.removed)c.value=this.join(o.slice(i,i+c.count)),i+=c.count;else{if(!c.added&&this.useLongestToken){let m=t.slice(r,r+c.count);m=m.map(function(f,p){const _=o[i+p];return _.length>f.length?_:f}),c.value=this.join(m)}else c.value=this.join(t.slice(r,r+c.count));r+=c.count,c.added||(i+=c.count)}}return n}}function Q(){const d=w(null),e=w(!1),t=new Map,o=()=>{const a=sessionStorage.getItem("token");if(!a){console.error("未找到认证token");return}const l=`${q}?token=${a}`;d.value=new WebSocket(l),d.value.onopen=()=>{e.value=!0,console.log("WebSocket 连接已建立");const r=JSON.parse(sessionStorage.getItem("user"));r&&d.value.send(JSON.stringify({type:"auth",data:{userId:r.userid,token:a}}))},d.value.onmessage=r=>{try{const i=JSON.parse(r.data);if(console.log("收到WebSocket消息:",i),!i.type){console.warn("收到未知类型的消息:",i);return}const c=t.get(i.type);c?c(i.data):console.warn("未找到消息处理器:",i.type)}catch(i){console.error("处理WebSocket消息时出错:",i),console.error("原始消息:",r.data)}},d.value.onclose=()=>{e.value=!1,console.log("WebSocket 连接已关闭"),setTimeout(o,3e3)},d.value.onerror=r=>{console.error("WebSocket 错误:",r),e.value=!1}},n=(a,l)=>{t.set(a,l)},u=(a,l)=>{if(!d.value||!e.value){console.warn("WebSocket未连接，无法发送消息");return}console.log("调用了SendMessage函数！");try{console.log(a,l),d.value.send(JSON.stringify({type:a,data:l}))}catch(r){console.error("发送消息失败:",r)}};return J(()=>{o()}),R(()=>{d.value&&d.value.close()}),{isConnected:e,sendMessage:u,registerHandler:n}}function X(){const{registerHandler:d,sendMessage:e}=Q();return d("permission_update",async o=>{const{fileId:n,newPermission:u,message:a}=o;await F.alert(a,"权限更新提示",{confirmButtonText:"确定",callback:()=>{const l=H.currentRoute.value.path;(l.includes(`/word/${n}`)||l.includes(`/excel/${n}`)||l.includes(`/edit/${n}`))&&window.location.reload()}})}),{sendPermissionUpdate:(o,n,u)=>{console.log("调用了sendPermissionUpdate函数！"),console.log(o,n,u),e("permission_update",{userId:o,fileId:n,newPermission:u})}}}const Y={class:"dialog-content"},Z={class:"user-list"},ee={class:"user-info"},oe={class:"user-details"},se={class:"username"},te={class:"user-id"},ne={class:"permission-action"},re={class:"dialog-footer"},ae={__name:"PermissionEditDialog",setup(d,{expose:e}){const t=w(!1),o=w([]),n=w(""),u=w(!1),a=z(),{sendPermissionUpdate:l}=X(),r=async(m,f)=>{n.value=m;try{const p=await N({fileId:m});if(p.code===200){let _=[];const y=p.data.map(async h=>{const v=h.user_id;try{const s=await B({targetUserId:v});return s.code===200?{user_id:v,username:s.data.username,userimg:s.data.userimg,permission:h.permission_type}:(console.error("用户信息获取失败:",s.msg),{user_id:v,username:"未知用户",userimg:"",permission:h.permission_type})}catch(s){return console.error("获取用户信息失败:",s),{user_id:v,username:"加载失败",userimg:"",permission:h.permission_type}}});_=await Promise.all(y),o.value=_,u.value=f===p.data[0].file_owner_id}t.value=!0}catch(p){console.error("获取权限记录失败：",p),I.error("获取权限记录失败")}},i=async m=>{try{const f=await T({userId:m.user_id,fileId:n.value,permissionType:m.permission});f.code===200?(I.success(`用户 ${m.username} 权限更新成功`),console.log("接下来的控制台输出是WebSocket的调用"),l(m.user_id,n.value,m.permission)):I.error(`权限更新失败: ${f.msg}`)}catch(f){console.error("修改权限失败：",f),I.error(`修改权限失败: ${f.message}`)}},c=m=>m?m.charAt(0).toUpperCase():"U";return e({openDialog:r}),(m,f)=>{const p=V("el-avatar"),_=V("el-option"),y=V("el-select"),h=V("el-button"),v=V("el-dialog");return S(),W(v,{modelValue:t.value,"onUpdate:modelValue":f[1]||(f[1]=s=>t.value=s),title:"修改权限",width:"800px"},{footer:C(()=>[P("span",re,[k(h,{onClick:f[0]||(f[0]=s=>t.value=!1)},{default:C(()=>[E("关闭")]),_:1})])]),default:C(()=>[P("div",Y,[P("div",Z,[(S(!0),A($,null,j(o.value,s=>(S(),A("div",{key:s.userid,class:"user-item"},[P("div",ee,[k(p,{size:36,src:s.userimg},{default:C(()=>[E(D(c(s.username)),1)]),_:2},1032,["src"]),P("div",oe,[P("div",se,D(s.username),1),P("div",te,"ID: "+D(s.user_id),1)])]),P("div",ne,[k(y,{modelValue:s.permission,"onUpdate:modelValue":g=>s.permission=g,disabled:!u.value,class:"permission-select"},{default:C(()=>[(S(!0),A($,null,j(K(a),g=>(S(),W(_,{key:g.value,label:g.label,value:g.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),k(h,{type:"primary",size:"small",disabled:!u.value,onClick:g=>i(s),class:"update-btn"},{default:C(()=>[E(" 修改 ")]),_:2},1032,["disabled","onClick"])])]))),128))])])]),_:1},8,["modelValue"])}}},he=G(ae,[["__scopeId","data-v-03234973"]]);export{_e as D,he as P,pe as a,me as c,ge as d,fe as g};
