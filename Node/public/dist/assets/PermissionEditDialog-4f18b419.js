import{N as U,r as w,q as j,am as T,an as B,E as z,f as q,_ as J,a as V,o as S,i as W,e as y,b as P,d as k,B as E,c as A,F as $,j as N,t as D,u as R,z as I}from"./index-f2f25b67.js";import{b as F,U as H}from"./index-774e13b4.js";import{g as G}from"./shareDialog-2ab7eedf.js";import{f as K}from"./index-50c106af.js";const de=d=>U({url:"/version/createVersion",method:"post",data:d}),me=d=>U({url:"/version/getAllVersions",method:"post",data:d}),fe=d=>U({url:"/version/getVersionSnapshot",method:"post",data:d}),pe=d=>U({url:"/version/deleteVersion",method:"post",data:d});class ge{diff(e,t,s={}){let n;typeof s=="function"?(n=s,s={}):"callback"in s&&(n=s.callback);const u=this.castInput(e,s),a=this.castInput(t,s),l=this.removeEmpty(this.tokenize(u,s)),r=this.removeEmpty(this.tokenize(a,s));return this.diffWithOptionsObj(l,r,s,n)}diffWithOptionsObj(e,t,s,n){var u;const a=o=>{if(o=this.postProcess(o,s),n){setTimeout(function(){n(o)},0);return}else return o},l=t.length,r=e.length;let i=1,c=l+r;s.maxEditLength!=null&&(c=Math.min(c,s.maxEditLength));const m=(u=s.timeout)!==null&&u!==void 0?u:1/0,f=Date.now()+m,p=[{oldPos:-1,lastComponent:void 0}];let _=this.extractCommon(p[0],t,e,0,s);if(p[0].oldPos+1>=r&&_+1>=l)return a(this.buildValues(p[0].lastComponent,t,e));let C=-1/0,h=1/0;const v=()=>{for(let o=Math.max(C,-i);o<=Math.min(h,i);o+=2){let g;const b=p[o-1],x=p[o+1];b&&(p[o-1]=void 0);let L=!1;if(x){const O=x.oldPos-o;L=x&&0<=O&&O<l}const M=b&&b.oldPos+1<r;if(!L&&!M){p[o]=void 0;continue}if(!M||L&&b.oldPos<x.oldPos?g=this.addToPath(x,!0,!1,0,s):g=this.addToPath(b,!1,!0,1,s),_=this.extractCommon(g,t,e,o,s),g.oldPos+1>=r&&_+1>=l)return a(this.buildValues(g.lastComponent,t,e))||!0;p[o]=g,g.oldPos+1>=r&&(h=Math.min(h,o-1)),_+1>=l&&(C=Math.max(C,o+1))}i++};if(n)(function o(){setTimeout(function(){if(i>c||Date.now()>f)return n(void 0);v()||o()},0)})();else for(;i<=c&&Date.now()<=f;){const o=v();if(o)return o}}addToPath(e,t,s,n,u){const a=e.lastComponent;return a&&!u.oneChangePerToken&&a.added===t&&a.removed===s?{oldPos:e.oldPos+n,lastComponent:{count:a.count+1,added:t,removed:s,previousComponent:a.previousComponent}}:{oldPos:e.oldPos+n,lastComponent:{count:1,added:t,removed:s,previousComponent:a}}}extractCommon(e,t,s,n,u){const a=t.length,l=s.length;let r=e.oldPos,i=r-n,c=0;for(;i+1<a&&r+1<l&&this.equals(s[r+1],t[i+1],u);)i++,r++,c++,u.oneChangePerToken&&(e.lastComponent={count:1,previousComponent:e.lastComponent,added:!1,removed:!1});return c&&!u.oneChangePerToken&&(e.lastComponent={count:c,previousComponent:e.lastComponent,added:!1,removed:!1}),e.oldPos=r,i}equals(e,t,s){return s.comparator?s.comparator(e,t):e===t||!!s.ignoreCase&&e.toLowerCase()===t.toLowerCase()}removeEmpty(e){const t=[];for(let s=0;s<e.length;s++)e[s]&&t.push(e[s]);return t}castInput(e,t){return e}tokenize(e,t){return Array.from(e)}join(e){return e.join("")}postProcess(e,t){return e}get useLongestToken(){return!1}buildValues(e,t,s){const n=[];let u;for(;e;)n.push(e),u=e.previousComponent,delete e.previousComponent,e=u;n.reverse();const a=n.length;let l=0,r=0,i=0;for(;l<a;l++){const c=n[l];if(c.removed)c.value=this.join(s.slice(i,i+c.count)),i+=c.count;else{if(!c.added&&this.useLongestToken){let m=t.slice(r,r+c.count);m=m.map(function(f,p){const _=s[i+p];return _.length>f.length?_:f}),c.value=this.join(m)}else c.value=this.join(t.slice(r,r+c.count));r+=c.count,c.added||(i+=c.count)}}return n}}function Q(){const d=w(null),e=w(!1),t=new Map,s=()=>{const a=sessionStorage.getItem("token");if(!a){console.error("未找到认证token");return}const l=`${B}?token=${a}`;d.value=new WebSocket(l),d.value.onopen=()=>{e.value=!0,console.log("WebSocket 连接已建立");const r=JSON.parse(sessionStorage.getItem("user"));r&&d.value.send(JSON.stringify({type:"auth",data:{userId:r.userid,token:a}}))},d.value.onmessage=r=>{try{const i=JSON.parse(r.data);if(console.log("收到WebSocket消息:",i),!i.type){console.warn("收到未知类型的消息:",i);return}const c=t.get(i.type);c?c(i.data):console.warn("未找到消息处理器:",i.type)}catch(i){console.error("处理WebSocket消息时出错:",i),console.error("原始消息:",r.data)}},d.value.onclose=()=>{e.value=!1,console.log("WebSocket 连接已关闭"),setTimeout(s,3e3)},d.value.onerror=r=>{console.error("WebSocket 错误:",r),e.value=!1}},n=(a,l)=>{t.set(a,l)},u=(a,l)=>{if(!d.value||!e.value){console.warn("WebSocket未连接，无法发送消息");return}console.log("调用了SendMessage函数！");try{console.log(a,l),d.value.send(JSON.stringify({type:a,data:l}))}catch(r){console.error("发送消息失败:",r)}};return j(()=>{s()}),T(()=>{d.value&&d.value.close()}),{isConnected:e,sendMessage:u,registerHandler:n}}function X(){const{registerHandler:d,sendMessage:e}=Q();return d("permission_update",async s=>{const{fileId:n,newPermission:u,message:a}=s;await z.alert(a,"权限更新提示",{confirmButtonText:"确定",callback:()=>{const l=q.currentRoute.value.path;(l.includes(`/word/${n}`)||l.includes(`/excel/${n}`)||l.includes(`/edit/${n}`))&&window.location.reload()}})}),{sendPermissionUpdate:(s,n,u)=>{console.log("调用了sendPermissionUpdate函数！"),console.log(s,n,u),e("permission_update",{userId:s,fileId:n,newPermission:u})}}}const Y={class:"dialog-content"},Z={class:"user-list"},ee={class:"user-info"},se={class:"user-details"},oe={class:"username"},te={class:"user-id"},ne={class:"permission-action"},re={class:"dialog-footer"},ae={__name:"PermissionEditDialog",setup(d,{expose:e}){const t=w(!1),s=w([]),n=w(""),u=w(!1),a=G(),{sendPermissionUpdate:l}=X(),r=async(m,f)=>{n.value=m;try{const p=await F({fileId:m});if(p.code===200){let _=[];const C=p.data.map(async h=>{const v=h.user_id;try{const o=await K({targetUserId:v});return o.code===200?{user_id:v,username:o.data.username,userimg:o.data.userimg,permission:h.permission_type}:(console.error("用户信息获取失败:",o.msg),{user_id:v,username:"未知用户",userimg:"",permission:h.permission_type})}catch(o){return console.error("获取用户信息失败:",o),{user_id:v,username:"加载失败",userimg:"",permission:h.permission_type}}});_=await Promise.all(C),s.value=_,u.value=f===p.data[0].file_owner_id}t.value=!0}catch(p){console.error("获取权限记录失败：",p),I.error("获取权限记录失败")}},i=async m=>{try{const f=await H({userId:m.user_id,fileId:n.value,permissionType:m.permission});f.code===200?(I.success(`用户 ${m.username} 权限更新成功`),console.log("接下来的控制台输出是WebSocket的调用"),l(m.user_id,n.value,m.permission)):I.error(`权限更新失败: ${f.msg}`)}catch(f){console.error("修改权限失败：",f),I.error(`修改权限失败: ${f.message}`)}},c=m=>m?m.charAt(0).toUpperCase():"U";return e({openDialog:r}),(m,f)=>{const p=V("el-avatar"),_=V("el-option"),C=V("el-select"),h=V("el-button"),v=V("el-dialog");return S(),W(v,{modelValue:t.value,"onUpdate:modelValue":f[1]||(f[1]=o=>t.value=o),title:"修改权限",width:"800px"},{footer:y(()=>[P("span",re,[k(h,{onClick:f[0]||(f[0]=o=>t.value=!1)},{default:y(()=>[E("关闭")]),_:1})])]),default:y(()=>[P("div",Y,[P("div",Z,[(S(!0),A($,null,N(s.value,o=>(S(),A("div",{key:o.userid,class:"user-item"},[P("div",ee,[k(p,{size:36,src:o.userimg},{default:y(()=>[E(D(c(o.username)),1)]),_:2},1032,["src"]),P("div",se,[P("div",oe,D(o.username),1),P("div",te,"ID: "+D(o.user_id),1)])]),P("div",ne,[k(C,{modelValue:o.permission,"onUpdate:modelValue":g=>o.permission=g,disabled:!u.value,class:"permission-select"},{default:y(()=>[(S(!0),A($,null,N(R(a),g=>(S(),W(_,{key:g.value,label:g.label,value:g.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),k(h,{type:"primary",size:"small",disabled:!u.value,onClick:g=>i(o),class:"update-btn"},{default:y(()=>[E(" 修改 ")]),_:2},1032,["disabled","onClick"])])]))),128))])])]),_:1},8,["modelValue"])}}},_e=J(ae,[["__scopeId","data-v-03234973"]]);export{ge as D,_e as P,fe as a,de as c,pe as d,me as g};
